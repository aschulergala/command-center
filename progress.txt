# GalaChain Command Center - Progress Log

## Learnings Section
(Patterns discovered, gotchas encountered, useful context for future iterations)
- NestJS project structure: src/ for backend, client/ for Vue, shared/ for types
- Use @nestjs/serve-static to serve Vue build from dist/client
- TypeScript paths configured for @shared/* imports
- nest-cli.json required for nest build command
- path-to-regexp v8+ syntax: use '/api{/*path}' not '/api/(.*)'
- Use SpaFallbackMiddleware instead of SpaFallbackController for SPA fallback (middleware is more reliable)
- Check req.originalUrl instead of req.path in middleware for accurate route matching
- __dirname resolves to src/ in dev and dist/src/ in production - use relative paths accordingly
- vue-tsc with noUnusedLocals treats type imports as unused when used in interfaces - re-export to fix
- Use `export type { }` for type-only re-exports with isolatedModules: true
- @gala-chain/api UserAlias and UserRef are branded types (string & { __marker__: void })
- BrowserConnectClient from @gala-chain/connect: use on/off for event listeners, connect() returns galaChainAddress
- Mock BrowserConnectClient in tests by creating a class with the same interface, not just an object
- vitest.config.ts needs @shared alias for shared types imports in tests

---

## Iteration 1 - project-setup
- What was implemented:
  - Initialized npm project with package.json
  - Installed NestJS core dependencies (@nestjs/common, core, platform-express, config, serve-static)
  - Created src/main.ts with NestJS bootstrap, CORS, validation pipe
  - Created src/app.module.ts with ConfigModule and ServeStaticModule
  - Created shared/ folder with types/wallet.ts placeholder
  - Created client/ folder with placeholder package.json
  - Created .gitignore for node_modules, dist, .env files
  - Created nest-cli.json and tsconfig.json
- Files changed:
  - package.json (new)
  - tsconfig.json (new)
  - nest-cli.json (new)
  - src/main.ts (new)
  - src/app.module.ts (new)
  - shared/index.ts (new)
  - shared/types/wallet.ts (new)
  - client/package.json (new)
  - .gitignore (new)
- GalaChain tools used: None (basic project setup)
- Tests: TypeScript typecheck passes, NestJS build passes
---

## Iteration 2 - vue-client-setup
- What was implemented:
  - Initialized Vite + Vue 3 + TypeScript in client/ folder
  - Installed Vue Router for client-side routing with routes: /tokens, /nfts, /creators, /export
  - Installed and configured Pinia for state management
  - Installed and configured Tailwind CSS with GalaChain brand colors
  - Installed @gala-chain/connect and @gala-chain/api packages
  - Installed VeeValidate + @vee-validate/zod for form validation
  - Installed @vueuse/core for Vue composition utilities
  - Installed axios for HTTP requests to backend API
  - Configured vite.config.ts: output to ../dist/client, proxy /api to NestJS in dev
  - Created folder structure: src/views/, src/components/, src/composables/, src/stores/, src/lib/
  - Configured path alias @ pointing to client/src/
  - Created placeholder views for all routes
  - Created style.css with Tailwind directives and custom component classes
- Files changed:
  - client/package.json (updated with full dependencies)
  - client/vite.config.ts (new)
  - client/tsconfig.json (new)
  - client/tsconfig.node.json (new)
  - client/index.html (new)
  - client/tailwind.config.js (new)
  - client/postcss.config.js (new)
  - client/.env (new)
  - client/src/main.ts (new)
  - client/src/App.vue (new)
  - client/src/style.css (new)
  - client/src/vite-env.d.ts (new)
  - client/src/router/index.ts (new)
  - client/src/lib/config.ts (new)
  - client/src/views/TokensView.vue (new)
  - client/src/views/NFTsView.vue (new)
  - client/src/views/CreatorsView.vue (new)
  - client/src/views/ExportView.vue (new)
  - package.json (updated test and typecheck scripts)
- GalaChain tools used: None (Vue setup)
- Tests: TypeScript compiles without errors, Vite build succeeds
- Learnings for future iterations:
  - Tailwind CSS brand colors defined as 'gala' namespace (gala-primary, gala-secondary, etc.)
  - Custom component classes (btn-primary, card, input) available in style.css
  - Path alias @ maps to client/src/ for clean imports
  - Pinia v3 used with Vue 3.5+
---

## Iteration 3 - nestjs-static-serving
- What was implemented:
  - Configured ServeStaticModule in app.module.ts to serve Vue build from dist/client
  - Created SpaFallbackController with wildcard route for SPA fallback
  - Fixed exclude pattern for new path-to-regexp syntax: '/api{/*path}'
  - Created AppController with health endpoint at GET /api/health
  - Set up Jest with ts-jest for server tests
  - Created unit tests for AppController
  - Created integration tests for static serving (spawns actual server process)
- Files changed:
  - src/app.module.ts (updated)
  - src/app.controller.ts (new)
  - src/spa-fallback.controller.ts (new)
  - src/__tests__/app.controller.spec.ts (new)
  - src/__tests__/app.e2e.spec.ts (new)
  - src/__tests__/static-serving.integration.spec.ts (new)
  - jest.config.js (new)
  - package.json (added Jest dependencies)
- GalaChain tools used: None (infrastructure setup)
- Tests: All 8 tests pass (3 unit, 1 e2e, 4 integration)
- Learnings for future iterations:
  - path-to-regexp v8+ syntax changed: use '/api{/*path}' instead of '/api/(.*)'
  - __dirname in NestJS changes between dev (src/) and production (dist/src/)
  - Use join(__dirname, '..', 'client') to resolve correctly in both contexts
  - ServeStaticModule doesn't have built-in SPA fallback - use a wildcard controller
  - Integration tests can spawn the actual server to test production behavior
  - Jest forceExit: true helps with child process cleanup
---

## Iteration 4 - environment-configuration
- What was implemented:
  - Created .env file at project root for NestJS with PORT, GALACHAIN_ENV, GALACHAIN_GATEWAY_URL, GALACHAIN_API_URL
  - Created .env.example documenting all variables for both server and client
  - Updated client/.env with VITE_GALACHAIN_ENV, VITE_GALACHAIN_GATEWAY_URL, VITE_GALACHAIN_API_URL
  - Created src/config/configuration.ts with typed AppConfiguration and validation
  - Updated app.module.ts to use ConfigModule.forRoot with load: [configuration]
  - Updated client/src/lib/config.ts with GalaChainConfig type and environment-based defaults
  - Created src/__tests__/configuration.spec.ts with comprehensive validation tests
  - Created client/vitest.config.ts and client/__tests__/config.spec.ts for client config tests
  - Added jsdom to client devDependencies for Vitest
  - Updated jest.config.js to exclude client/ tests (run by Vitest instead)
- Files changed:
  - .env (new)
  - .env.example (new)
  - client/.env (updated)
  - src/config/configuration.ts (new)
  - src/app.module.ts (updated)
  - client/src/lib/config.ts (updated)
  - src/__tests__/configuration.spec.ts (new)
  - client/vitest.config.ts (new)
  - client/__tests__/config.spec.ts (new)
  - client/package.json (added jsdom)
  - jest.config.js (updated)
- GalaChain tools used: None (configuration setup)
- Tests: 37 total tests pass (25 server + 12 client)
- Learnings for future iterations:
  - NestJS ConfigModule.forRoot accepts load: [configFn] for custom configuration factories
  - Vitest needs jsdom for DOM environment in tests
  - Jest testRegex should include path prefix (src/) to avoid running client tests
  - Client config uses import.meta.env for Vite environment variables
  - Environment defaults should be based on GALACHAIN_ENV (production vs stage)
---

## Iteration 5 - shared-types
- What was implemented:
  - Created shared/types/galachain.ts re-exporting types from @gala-chain/api
    - Core types: TokenClass, TokenClassKey, TokenInstance, TokenInstanceKey, TokenBalance, TokenAllowance
    - DTOs: TransferTokenDto, MintTokenDto, BurnTokensDto, CreateTokenClassDto, etc.
    - Response types: GalaChainResponse, GalaChainResponseType
    - User types: UserAlias, UserRef with validation functions
  - Updated shared/types/wallet.ts with comprehensive wallet state types
    - WalletState interface with connected, address, publicKey, isConnecting, error
    - WalletConnectionStatus enum
    - WalletProvider enum
    - WalletConnectionResult interface
  - Created shared/types/display.ts with UI display interfaces
    - FungibleTokenDisplay for fungible token cards
    - NFTDisplay for NFT cards
    - CollectionDisplay for NFT collections
    - AllowanceDisplay for token allowances
    - TransactionResult for transaction outcomes
    - TransactionType and TransactionStatus enums
    - PendingTransaction for tracking in-progress transactions
  - Updated shared/index.ts to export all types
  - Configured tsconfig paths for both server and client (@shared/*)
  - Updated vite.config.ts with @shared alias
  - Installed @gala-chain/api in root package
- Files changed:
  - shared/types/galachain.ts (new)
  - shared/types/wallet.ts (updated)
  - shared/types/display.ts (new)
  - shared/index.ts (updated)
  - client/tsconfig.json (updated - added @shared/* path and ../shared/**/*.ts to include)
  - client/vite.config.ts (updated - added @shared alias)
  - package.json (updated - added @gala-chain/api dependency)
- GalaChain tools used: None (used direct inspection of @gala-chain/api type definitions)
- Tests: All 37 tests pass (12 client + 25 server)
- Learnings for future iterations:
  - vue-tsc with noUnusedLocals: true treats type-only imports as unused even when used in interfaces
  - Workaround: Re-export the imported types to mark them as "used"
  - Use `export type { }` for type-only re-exports with isolatedModules: true
  - UserAlias and UserRef are branded types (string & { __marker__: void })
  - @gala-chain/api exports classes (TokenClass), interfaces (TokenClassKeyProperties), and enums (AllowanceType)
---

## Iteration 6 - nestjs-health-api
- What was implemented:
  - Created src/modules/health/health.module.ts for dedicated health module
  - Created src/modules/health/health.controller.ts with GET /api/health endpoint
  - Created src/middleware/request-logger.middleware.ts for development logging
  - Updated app.module.ts to import HealthModule and configure RequestLoggerMiddleware
  - Removed old app.controller.ts (health endpoint moved to HealthController)
  - Created unit tests for HealthController in src/modules/health/__tests__/health.controller.spec.ts
  - Updated e2e test to use HealthController
- Files changed:
  - src/modules/health/health.module.ts (new)
  - src/modules/health/health.controller.ts (new)
  - src/modules/health/__tests__/health.controller.spec.ts (new)
  - src/middleware/request-logger.middleware.ts (new)
  - src/app.module.ts (updated)
  - src/__tests__/app.e2e.spec.ts (updated)
  - src/app.controller.ts (deleted)
  - src/__tests__/app.controller.spec.ts (deleted)
- GalaChain tools used: None (infrastructure setup)
- Tests: All 38 tests pass (12 client + 26 server)
- Learnings for future iterations:
  - NestJS modules keep code organized - one module per feature area
  - Middleware configured via NestModule.configure() with MiddlewareConsumer
  - Apply middleware conditionally based on NODE_ENV for dev-only features
  - Use @Controller('health') prefix for nested routes under /api/health
---

## Iteration 7 - railway-deployment
- What was implemented:
  - Created Procfile with `web: node dist/src/main.js`
  - Created railway.json with build/deploy configuration and health check
  - Created README.md with development setup, scripts, and Railway deployment instructions
  - Fixed nest-cli.json to use `deleteOutDir: false` so Vue build isn't wiped during NestJS build
  - Updated package.json paths to use dist/src/main.js (NestJS compiles src/ to dist/src/)
  - Replaced SpaFallbackController with SpaFallbackMiddleware for reliable SPA routing
  - Fixed middleware to use req.originalUrl for accurate /api route detection
- Files changed:
  - Procfile (new)
  - railway.json (new)
  - README.md (new)
  - nest-cli.json (updated - deleteOutDir: false)
  - package.json (updated - paths to dist/src/main.js)
  - src/main.ts (updated - simplified global prefix)
  - src/app.module.ts (updated - removed SpaFallbackController, added SpaFallbackMiddleware)
  - src/middleware/spa-fallback.middleware.ts (new)
  - src/spa-fallback.controller.ts (updated - cleaned up unused imports)
- GalaChain tools used: None (deployment configuration)
- Tests: All 38 tests pass (12 client + 26 server)
- Learnings for future iterations:
  - NestJS nest build with deleteOutDir: true wipes entire dist folder including Vue build
  - Set deleteOutDir: false when Vue outputs to dist/client alongside NestJS dist/src
  - In middleware, use req.originalUrl instead of req.path for accurate route detection
  - Windows doesn't support NODE_ENV=value prefix - Railway/Linux will set it automatically
  - Middleware runs BEFORE controllers - order registration carefully
---

## Iteration 8 - wallet-connection
- What was implemented:
  - Created client/src/stores/wallet.ts Pinia store with:
    - State: connected, address, publicKey, isConnecting, error
    - Actions: connect(), disconnect(), checkConnection(), getClient(), clearError()
    - Getters: status, truncatedAddress, state
    - Uses @gala-chain/connect BrowserConnectClient for MetaMask integration
    - Uses @vueuse/core useStorage for localStorage persistence (auto-reconnect)
  - Created client/src/composables/useWallet.ts wrapping store for component use
  - Created client/src/components/WalletConnect.vue with:
    - "Connect Wallet" button with loading state
    - Truncated address display when connected with green indicator
    - Dropdown menu with disconnect option
    - Error message display with dismiss button
    - Auto-reconnect on mount via checkConnection()
  - Added comprehensive tests (14 store tests, 10 component tests)
- Files changed:
  - client/src/stores/wallet.ts (new)
  - client/src/composables/useWallet.ts (new)
  - client/src/components/WalletConnect.vue (new)
  - client/__tests__/stores/wallet.spec.ts (new)
  - client/__tests__/components/WalletConnect.spec.ts (new)
  - client/vitest.config.ts (updated - added @shared alias)
  - manualTestingRequired.txt (new - tracks manual testing checklist)
- GalaChain tools used: Inspected @gala-chain/connect type definitions for BrowserConnectClient API
- Tests: All 62 tests pass (36 client + 26 server)
- Learnings for future iterations:
  - BrowserConnectClient.connect() returns the galaChain address directly
  - BrowserConnectClient provides on/off methods for event listeners (accountsChanged)
  - Use getPublicKey() after connect() to retrieve the public key
  - Mock BrowserConnectClient in tests as a class, not just an object literal
  - Use mockReturnThis() for chainable methods like on() and off()
  - @pinia/testing createTestingPinia() allows setting initialState for component tests
---

